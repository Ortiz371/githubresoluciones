<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador Exacto de Resoluciones</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-image: linear-gradient(to right top, #051937, #004d7a, #008793, #00bf72, #a8eb12);
            color: white;
            min-height: 100vh;
            position: relative;
        }
        .search-container {
            max-width: 100%;
            margin: 0 auto 30px;
        }
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .logo-container {
            height:90px;
        }
        .logo-container img {
            height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
        .search-header {
            text-align: center;
            position: relative;
            flex-grow: 1;
            min-width: 300px;
        }
        .search-filters {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .filter-group {
            min-width: 250px;
            text-align: center;
        }
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 16px;
        }
        #searchTerm {
            width: 100%;
            padding: 12px;
            border-radius: 25px;
            border: 2px solid #fff;
            background-color: rgba(255,255,255,0.2);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }
        #searchType, #yearFilter {
            width: 100%;
            padding: 12px;
            border-radius: 25px;
            border: 2px solid #fff;
            background-color: rgba(255,255,255,0.2);
            color: white;
            font-size: 16px;
            cursor: pointer;
            box-sizing: border-box;
        }
        option {
            background-color: #004d7a;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: rgba(255,255,255,0.1);
            margin-top: 20px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th {
            background-color: rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
        }
        tr:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .pdf-link {
            color: #006400;
            text-decoration: none;
            font-weight: bold;
        }
        .pdf-link:hover {
            text-decoration: underline;
            color: #004d00;
        }
        .no-results {
            padding: 20px;
            text-align: center;
            background-color: rgba(255,0,0,0.2);
            border-left: 4px solid red;
            margin-top: 20px;
            display: none;
            border-radius: 5px;
        }
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                text-align: center;
            }
            .search-filters {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            .filter-group {
                width: 100%;
                max-width: 300px;
            }
            table {
                display: block;
                overflow-x: auto;
            }
        }
        
        /* Estilos para el botón y modal de carga */
        .load-btn {
            position: absolute;
            top: 10px;
            right: 20px;
            padding: 10px 20px;
            background-color: rgba(255,255,255,0.2);
            border: 2px solid #fff;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .load-btn:hover {
            background-color: rgba(255,255,255,0.3);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #004d7a;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h2 {
            margin-top: 0;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: rgba(255,255,255,0.9);
        }
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .submit-btn {
            background-color: #00bf72;
            color: white;
        }
        .cancel-btn {
            background-color: #ff6b6b;
            color: white;
        }
        .password-modal {
            text-align: center;
        }
        .password-input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
            width: 80%;
        }
        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="logo-container">
            <img src="https://i.postimg.cc/PxbJyLWD/Logo-Secretaria-de-Planeamiento-Educativo-y-Desarrollo-Profesional-Docente.png" alt="Logo Secretaría">
        </div>
        <div class="title-container">
            <h1></h1>
            <H2></H2>
        </div>
        <button class="load-btn" id="loadBtn">Cargar</button>
    </div>
        
        <div class="search-filters">
            <div class="filter-group">
                <label for="searchType">Tipo de Búsqueda</label>
                <select id="searchType" onchange="updatePlaceholder()">
                    <option value="all">Búsqueda General</option>
                    <option value="resolucion">Por Resolución</option>
                    <option value="tema">Por Tema</option>
                    <option value="expediente">Por Expediente</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="searchTerm">Término de Búsqueda</label>
                <input type="text" id="searchTerm" placeholder="Buscar..." onkeyup="searchData()">
            </div>
            
            <div class="filter-group">
                <label for="yearFilter">Filtrar por Año</label>
                <select id="yearFilter" onchange="searchData()">
                    <option value="all">Todos los años</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                </select>
            </div>
        </div>
        
        <div id="noResults" class="no-results">No se encontraron resultados para su búsqueda.</div>

        <table id="dataTable">
            <thead>
                <tr>
                    <th>RES.</th>
                    <th>CÓD.</th>
                    <th>EXPTE.</th>
                    <th>TEMA CARATULA</th>
                    <th>PDF</th>
                    <th>AÑO</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Los datos se cargarán aquí -->
            </tbody>
        </table>
    </div>

    <!-- Modal para contraseña -->
    <div id="passwordModal" class="modal">
        <div class="modal-content password-modal">
            <h2>Ingrese la clave de acceso</h2>
            <input type="password" id="passwordInput" class="password-input" placeholder="Clave">
            <div class="form-actions">
                <button id="cancelPasswordBtn" class="cancel-btn">Cancelar</button>
                <button id="submitPasswordBtn" class="submit-btn">Aceptar</button>
            </div>
            <p id="passwordError" style="color: #ff6b6b; display: none;">Clave incorrecta. Intente nuevamente.</p>
        </div>
    </div>

    <!-- Modal para cargar datos -->
    <div id="loadModal" class="modal">
        <div class="modal-content">
            <h2>Cargar Nueva Resolución</h2>
            <form id="dataForm">
                <div class="form-group">
                    <label for="resolucion">RES.</label>
                    <input type="text" id="resolucion" required>
                </div>
                <div class="form-group">
                    <label for="codigo">CÓD.</label>
                    <input type="text" id="codigo" required>
                </div>
                <div class="form-group">
                    <label for="expediente">EXPTE.</label>
                    <input type="text" id="expediente" required>
                </div>
                <div class="form-group">
                    <label for="tema">TEMA CARATULA</label>
                    <input type="text" id="tema" required>
                </div>
                <div class="form-group">
                    <label for="pdf">PDF (Enlace Drive)</label>
                    <input type="url" id="pdf" required>
                </div>
                <div class="form-group">
                    <label for="anio">AÑO</label>
                    <select id="anio" required>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancelLoadBtn" class="cancel-btn">Cancelar</button>
                    <button type="submit" class="submit-btn">Guardar</button>
                </div>
            </form>
            <div id="loadingIndicator" class="loading">
                <div class="loading-spinner"></div>
                <p>Cargando datos...</p>
                <p id="statusMessage"></p>
            </div>
        </div>
    </div>

    <script>
        // Datos globales
        let allResolutions = [];
        let filteredResolutions = [];
        const API_URL = 'https://sheetdb.io/api/v1/tvbu543znoh1s';
        const CORRECT_PASSWORD = 'ktmmgs00';

        // Elementos del DOM
        const loadBtn = document.getElementById('loadBtn');
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');
        const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
        const passwordError = document.getElementById('passwordError');
        const loadModal = document.getElementById('loadModal');
        const cancelLoadBtn = document.getElementById('cancelLoadBtn');
        const dataForm = document.getElementById('dataForm');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const statusMessage = document.getElementById('statusMessage');

        // Función para cargar datos desde SheetDB.io
        async function loadData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Error al cargar los datos');
                
                const data = await response.json();
                if (!Array.isArray(data)) throw new Error('Formato de datos inválido');
                
                // Mapear los nombres de las columnas según lo que recibe de SheetDB
                allResolutions = data.map(item => ({
                    'RES.': item['RES.'] || '',
                    'CÓD.': item['CÓD.'] || '',
                    'EXPTE.': item['EXPTE.'] || '',
                    'TEMA CARATULA': item['TEMA CARATULA'] || '',
                    'PDF': item['PDF'] || '',
                    'AÑO': item['AÑO'] || ''
                }));
                
                filteredResolutions = [...allResolutions];
                renderTable(allResolutions);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('tableBody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #ff6b6b;">
                            Error al cargar los datos: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Función para actualizar el placeholder según el tipo de búsqueda
        function updatePlaceholder() {
            const searchType = document.getElementById('searchType').value;
            const searchTerm = document.getElementById('searchTerm');
            
            switch(searchType) {
                case 'resolucion':
                    searchTerm.placeholder = "Ej: R1 (búsqueda exacta)";
                    break;
                case 'tema':
                    searchTerm.placeholder = "Ej: CALENDARIO ESCOLAR";
                    break;
                case 'expediente':
                    searchTerm.placeholder = "Ej: EX-2024-001";
                    break;
                default:
                    searchTerm.placeholder = "Buscar en todos los campos...";
            }
            
            // Disparar búsqueda cuando se cambia el tipo
            searchData();
        }

        // Función para renderizar la tabla
        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center;">
                            No hay datos disponibles
                        </td>
                    </tr>
                `;
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item['RES.'] || 'N/A'}</td>
                    <td>${item['CÓD.'] || 'N/A'}</td>
                    <td>${item['EXPTE.'] || 'N/A'}</td>
                    <td>${item['TEMA CARATULA'] || 'Sin descripción disponible'}</td>
                    <td>
                        ${item['PDF'] ? 
                            `<a href="${item['PDF']}" class="pdf-link" target="_blank">Ver PDF</a>` : 
                            'No disponible'}
                    </td>
                    <td>${item['AÑO'] || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Función de búsqueda exacta
        function searchData() {
            const searchTerm = document.getElementById('searchTerm').value.toUpperCase();
            const searchType = document.getElementById('searchType').value;
            const selectedYear = document.getElementById('yearFilter').value;
            
            filteredResolutions = allResolutions.filter(item => {
                // Filtro por año
                const yearMatch = selectedYear === 'all' || (item['AÑO'] && item['AÑO'].toString() === selectedYear);
                
                // Si no hay término de búsqueda, solo aplicar filtro de año
                if (!searchTerm) return yearMatch;
                
                // Filtro según el tipo de búsqueda seleccionado
                switch(searchType) {
                    case 'resolucion':
                        // Búsqueda EXACTA para resoluciones
                        return yearMatch && (item['RES.'] && item['RES.'].toUpperCase() === searchTerm);
                    case 'tema':
                        // Búsqueda que contiene para temas
                        return yearMatch && (item['TEMA CARATULA'] && item['TEMA CARATULA'].toUpperCase().includes(searchTerm));
                    case 'expediente':
                        // Búsqueda exacta para expedientes
                        return yearMatch && (item['EXPTE.'] && item['EXPTE.'].toUpperCase() === searchTerm);
                    default: // Búsqueda general
                        return yearMatch && (
                            (item['RES.'] && item['RES.'].toUpperCase().includes(searchTerm)) ||
                            (item['CÓD.'] && item['CÓD.'].toUpperCase().includes(searchTerm)) ||
                            (item['EXPTE.'] && item['EXPTE.'].toUpperCase().includes(searchTerm)) ||
                            (item['TEMA CARATULA'] && item['TEMA CARATULA'].toUpperCase().includes(searchTerm))
                        );
                }
            });

            renderTable(filteredResolutions);
            document.getElementById('noResults').style.display = 
                filteredResolutions.length === 0 && (searchTerm || selectedYear !== 'all') ? 'block' : 'none';
        }

        // Función para mostrar el modal de contraseña
        function showPasswordModal() {
            passwordModal.style.display = 'flex';
            passwordInput.focus();
        }

        // Función para ocultar el modal de contraseña
        function hidePasswordModal() {
            passwordModal.style.display = 'none';
            passwordInput.value = '';
            passwordError.style.display = 'none';
        }

        // Función para mostrar el modal de carga
        function showLoadModal() {
            loadModal.style.display = 'flex';
            // Resetear el formulario
            dataForm.reset();
            loadingIndicator.style.display = 'none';
        }

        // Función para ocultar el modal de carga
        function hideLoadModal() {
            loadModal.style.display = 'none';
        }

        // Función para enviar datos a SheetDB.io
        async function submitData(formData) {
            loadingIndicator.style.display = 'block';
            statusMessage.textContent = 'Enviando datos...';
            
            try {
                // Asegurarse que los nombres de las columnas coincidan exactamente
                const dataToSend = {
                    'RES.': formData.resolucion,
                    'CÓD.': formData.codigo,
                    'EXPTE.': formData.expediente,
                    'TEMA CARATULA': formData.tema,
                    'PDF': formData.pdf,
                    'AÑO': formData.anio
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data: [dataToSend]
                    })
                });
                
                if (!response.ok) throw new Error('Error al enviar los datos');
                
                const result = await response.json();
                if (result.created !== 1) throw new Error('No se pudo crear el registro');
                
                statusMessage.textContent = '¡Datos cargados exitosamente!';
                statusMessage.style.color = '#00bf72';
                
                setTimeout(() => {
                    hideLoadModal();
                    loadData();
                }, 1500);
            } catch (error) {
                console.error('Error al enviar datos:', error);
                statusMessage.textContent = `Error: ${error.message}`;
                statusMessage.style.color = '#ff6b6b';
            }
        }

        // Event Listeners
        loadBtn.addEventListener('click', showPasswordModal);
        
        cancelPasswordBtn.addEventListener('click', hidePasswordModal);
        
        submitPasswordBtn.addEventListener('click', () => {
            if (passwordInput.value === CORRECT_PASSWORD) {
                hidePasswordModal();
                showLoadModal();
            } else {
                passwordError.style.display = 'block';
                passwordInput.focus();
            }
        });
        
        cancelLoadBtn.addEventListener('click', hideLoadModal);
        
        dataForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = {
                resolucion: document.getElementById('resolucion').value,
                codigo: document.getElementById('codigo').value,
                expediente: document.getElementById('expediente').value,
                tema: document.getElementById('tema').value,
                pdf: document.getElementById('pdf').value,
                anio: document.getElementById('anio').value
            };
            
            submitData(formData);
        });

        // Cerrar modales al hacer clic fuera del contenido
        window.addEventListener('click', (e) => {
            if (e.target === passwordModal) {
                hidePasswordModal();
            }
            if (e.target === loadModal) {
                hideLoadModal();
            }
        });

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
